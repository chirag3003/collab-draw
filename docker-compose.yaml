services:
  mongo:
    image: mongo
    restart: always
    ports:
      - 27017:27017
    volumes:
      - mongo-data:/data/db

  keycloak:
    image: quay.io/keycloak/keycloak:26.5.4
    command: ["start-dev", "--import-realm"]
    environment:
      - KC_BOOTSTRAP_ADMIN_USERNAME=${KEYCLOAK_ADMIN:-admin}
      - KC_BOOTSTRAP_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD:-admin}
      - KC_HOSTNAME=http://localhost:8080
      - KC_HOSTNAME_STRICT=false
      - KC_HOSTNAME_BACKCHANNEL_DYNAMIC=true
    ports:
      - "8080:8080"
    volumes:
      - ./infra/collabdraw.json:/opt/keycloak/data/import/collabdraw.json:ro
      - keycloak-data:/opt/keycloak/data
    restart: unless-stopped

  api:
    build: ./packages/api
    ports:
      - "5005:5005"
    restart: unless-stopped
    environment:
      - PORT=5005
      - MONGO_URI=mongodb://mongo:27017
      - MONGO_DATABASE=collab-dev
      - KEYCLOAK_URL=http://keycloak:8080
      - KEYCLOAK_PUBLIC_URL=http://localhost:8080
      - KEYCLOAK_REALM=collab-draw
      - KEYCLOAK_CLIENT_ID=collab-draw
      - KEYCLOAK_API_CLIENT_ID=collab-draw-api
      - KEYCLOAK_API_CLIENT_SECRET=collab-draw-api-dev-secret
    depends_on:
      - mongo
      - keycloak
    develop:
      watch:
        - action: sync+restart
          path: ./packages/api
          target: /app
          ignore:
            - vendor/
        - action: rebuild
          path: ./packages/api/go.mod
        - action: rebuild
          path: ./packages/api/go.sum

  web:
    build: ./packages/web
    ports:
      - "3080:3080"
    restart: unless-stopped
    environment:
      - KEYCLOAK_CLIENT_ID=collab-draw
      - KEYCLOAK_CLIENT_SECRET=collab-draw-dev-secret
      - KEYCLOAK_URL=http://keycloak:8080
      - KEYCLOAK_REALM=collab-draw
      - AUTH_SECRET=dev-secret-change-in-production
      - INTERNAL_API_URL=http://api:5005
      - NEXT_PUBLIC_APP_URL=http://localhost:3080
      - NEXT_PUBLIC_KEYCLOAK_URL=http://localhost:8080
      - NEXT_PUBLIC_KEYCLOAK_REALM=collab-draw
      - NEXT_PUBLIC_API_WS_URL=ws://localhost:5005
    depends_on:
      - api
      - keycloak
    develop:
      watch:
        - action: sync
          path: ./packages/web
          target: /app
          ignore:
            - node_modules/
            - .next/
        - action: rebuild
          path: ./packages/web/package.json

volumes:
  mongo-data:
  keycloak-data:
